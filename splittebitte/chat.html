<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <h2 id="restaurant-title"></h2>
    <div id="chat-container">
      <div
        id="chat-messages"
        style="border: 1px solid #ccc; height: 300px; overflow-y: scroll;"
      ></div>
      <input type="text" id="chat-input" placeholder="Type your message here..." />
      <button id="send-button">Send</button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script>
      // Get the selected restaurant from localStorage
      const restaurantName = localStorage.getItem("selectedRestaurant") || "Chat Room";
      document.getElementById("restaurant-title").innerText = "Chat for " + restaurantName;

      // Reference to the Firestore collection for this restaurant's chat
      const chatRef = db
        .collection("chats")
        .doc(restaurantName)
        .collection("messages");

      // Send message when button is clicked or Enter key is pressed
      document.getElementById("send-button").addEventListener("click", sendMessage);
      document.getElementById("chat-input").addEventListener("keyup", function (e) {
        if (e.key === "Enter") sendMessage();
      });

      function sendMessage() {
        const message = document.getElementById("chat-input").value;
        if (message.trim() === "") return;

        const user = firebase.auth().currentUser;
        if (user) {
          chatRef.add({
            message: message,
            sender: user.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
          document.getElementById("chat-input").value = "";
        } else {
          alert("You are not logged in!");
        }
      }

      // Listen for new messages in real time
      chatRef
        .orderBy("timestamp")
        .onSnapshot((snapshot) => {
          const chatMessages = document.getElementById("chat-messages");
          chatMessages.innerHTML = ""; // Clear previous messages
          snapshot.forEach((doc) => {
            const msgData = doc.data();
            const messageElement = document.createElement("p");
            messageElement.textContent = msgData.sender + ": " + msgData.message;
            chatMessages.appendChild(messageElement);
          });
        });

      // Check if the user is logged in; if not, redirect to login page
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = "index.html";
        }
      });
    </script>
  </body>
</html>
